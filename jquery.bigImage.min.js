// jquery.bigImage.js
//  @weblinc, @bencrouse, (c) 2012

(function(a){function c(b,c){var d=a.extend(!0,a.bigImage.defaultSettings,c);return a.bigImage.settings[b.data("bigImageId")]=d,d}function d(b){return a.bigImage.settings[b.data("bigImageId")]}function e(b,d){var e=(new Date).getTime();return a.bigImage.anchors.push(b[0]),b.data("bigImageId",e),c(b,d),b.bind("click.bigImage",function(a){a.preventDefault()})}function f(a){var b=d(a),c=h(a),e=j(a),f=i(a),k=g(a);a.css({display:"block"});var l=a.offset();k.css({overflow:"hidden",width:Math.ceil(b.zoom.width)+"px",height:Math.ceil(b.zoom.height)+"px",position:"absolute",top:l.top,left:l.left+a.outerWidth()}),e.css({position:"absolute"}),f.css({position:"absolute"}),b.autoStyle&&(a.css({position:"relative"}),c.css({zIndex:999}),e.css({zIndex:1e3}))}function g(b){var c=a.bigImage.zoomMasks[b.data("bigImageId")];if(!c){var e=d(b)||{zoom:{}},f=u(e.zoom.maskElement);c=a.bigImage.zoomMasks[b.data("bigImageId")]=f.appendTo("body")}return c}function h(b){var c=a("img:first",b);return c.length||t("anchor must have a image child"),c}function i(b){var c=g(b),d=a("img:first",c);return d.length||(d=a("<img/>").appendTo(c)),d}function j(b){var c=a.bigImage.lenses[b.data("bigImageId")];if(!c){var e=d(b),f=u(e.lens.element);c=a.bigImage.lenses[b.data("bigImageId")]=f.appendTo(b)}return c}function l(a,b,c){var d=a.attr("src"),e=b.attr("src"),f=[d,e].join();if(k[f]){c(k[f]);return}s(d,e,function(){var d={height:a.height()/b[0].height,width:a.width()/b[0].width};if(!isFinite(d.height)||!isFinite(d.width)){setTimeout(function(){l(a,b,c)},5);return}k[f]=d,c(d)})}function m(a,b,c){l(b,c,function(c){var e=b.closest("a"),f=d(e),g={height:Math.ceil(c.height*f.zoom.height),width:Math.ceil(c.width*f.zoom.width)};a.css({height:g.height+"px",width:g.width+"px"})})}function n(a){g(a).css({left:a.offset().left+a.outerWidth()});var b=r(a),c=j(a);b&&p(c,h(a),i(a),b),c.show()}function o(b){a(".zoom-mask").css({left:"-9999px"}),j(b).hide()}function p(a,b,c,d){l(b,c,function(e){var f=b.offset(),g=a.outerHeight(),h=a.outerWidth(),i=d[1]-f.top-g/2,j=d[0]-f.left-h/2,k=b.height()-g+v(),l=b.width()-h+v();i<0&&(i=0),j<0&&(j=0),i>k&&(i=k),j>l&&(j=l),a.css({top:Math.ceil(i)+"px",left:Math.ceil(j)+"px"});var m=i/e.height,n=j/e.width;c.css({top:0-Math.ceil(m)+"px",left:0-Math.ceil(n)+"px"})})}function q(b,c){var d=b.data("bigImageId");return a.bigImage.lastPositions[d]=c}function r(b){var c=b.data("bigImageId");return a.bigImage.lastPositions[c]?a.bigImage.lastPositions[c]:null}function s(){function f(){var b=!0;return a.each(c,function(c,d){b=b&&a.inArray(d,e)>=0}),b}var b=a.makeArray(arguments),c=b.slice(0,b.length-1),d=b[b.length-1],e=[];a.each(c,function(b,c){a("<img/>").load(function(){e.push(c),f()&&(d(),a(this).remove())}).get(0).src=c})}function t(a){throw"BigImage Error: "+a}function u(b){return a.isFunction(b)&&(b=b()),b=a(b),b.length||t(name+" must be a valid HTML string or return a valid DOM object"),b}function v(){return a.browser.msie&&~~a.browser.version<=7?4:0}var b={init:function(b){return typeof b[0]=="undefined"||a.isPlainObject(b[0])},changeImage:function(b){return b[0]==="changeImage"&&a.isPlainObject(b[1])},destroy:function(a){return a[0]==="destroy"}};a.bigImage={settings:{},zoomMasks:{},lenses:{},anchors:[],lastPositions:{}},a.extend(a.bigImage,{defaultSettings:{autoStyle:!0,zoom:{width:500,height:500,maskElement:'<div class="zoom-mask"></div>'},lens:{element:"<div/>",loadingElement:'<span class="loading">Loading...</span>'}},init:function(b,c){var d=a(b),g=d.attr("href");if(d.data("bigImageId"))return;e(d,c);var k=d.data("bigImageId"),r=h(d),s=i(d),t=j(d);s.attr("src",g),m(t,r,s),o(d),l(r,s,function(){d.bind("mouseenter.bigImage",function(){n(d),d.bind("mousemove.bigImage",function(a){p(t,r,s,[a.pageX,a.pageY]),q(d,[a.pageX,a.pageY])})}).bind("mouseleave.bigImage",function(){o(d),q(d,null),r.unbind("mousemove.bigImage")}),f(d),o(d)})},changeImage:function(b,c){var e=a(b),f=e.data("bigImageId");f||t("must be initialized to change image");var k=j(e),n=u(d(e).lens.loadingElement),o=h(e),p=i(e);c=a.extend({smallImageUrl:o.attr("src")},c),k.append(n),e.attr("href",c.largeImageUrl),o.attr("src",c.smallImageUrl),p.attr("src",c.largeImageUrl),g(e).show(),l(o,p,function(){m(k,o,p),n.remove()})},destroy:function(b){var c=a(b);c.data("bigImageId")||t("plugin not initialized");var d=j(c);id=c.data("bigImageId"),d.remove(),g(c).remove(),c.unbind(".bigImage").data("bigImageId",null),a.bigImage.zoomMasks[id]=null,a.bigImage.settings[id]=null;var e=a.inArray(b,a.bigImage.anchors);a.bigImage.anchors.splice(e,1)}}),a.fn.bigImage=function(){function f(b){return a(b).each(function(){a.bigImage[d](this,e)})}var c=a.makeArray(arguments),d=null,e=c[c.length-1];a.each(b,function(a,b){b(c)&&(d=a)}),d||t("invalid method name");var g=this;return f(g),g};var k={};a(document).bind("destroy.bigImage",function(){a.each(a.bigImage.anchors,function(b,c){a(c).bigImage("destroy")})})})(jQuery)